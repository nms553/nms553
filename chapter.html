<!DOCTYPE html>
<html>

  <head>
    <link href="css/main.css" rel="stylesheet" />
    <title>Bible API Example Application</title>
  </head>

  <body class="index">
    <header>
      <div class="container">
        <h1>
          <a class="flex" href="/">
            <span class="logo" title="American Bible Society">ABS</span>
            <span>API Demo App</span>
          </a>
        </h1>
      </div>
    </header>
    <div class="subheader">
      <div class="container flex">
        <div class="subheadings">
          <h2>Viewing:</h2>
          <h3 id="viewing"></h3>
        </div>
        <div class="search-area flex">
          <button onclick="searchButton()">ðŸ”Ž</button>
          <input type="text" id="search-input" placeholder="ex. 'John 3:16-19' OR 'kingdom'" size="30" onkeydown="if (event.keyCode == 13) searchButton()" />
        </div>
      </div>
    </div>
    <div class="container crumbs">
      <div id="breadcrumbs"></div>
    </div>
    <main class="container">
      <h4 class="list-heading"><span>Select a Chapter</span></h4>
      <div id="chapter-list" class="list-container numeric-list"></div>
    </main>
    <script src="js/my_key.js"></script>
    <script>
      const bibleChapterList = document.querySelector(`#chapter-list`);
      const bibleVersionID = getParameterByName(`version`);
      const bibleBookID = getParameterByName(`book`);
      const abbreviation = getParameterByName(`abbr`);

      let chapterHTML = ``;

      if (!bibleVersionID || !bibleBookID) {
        window.location.href = `./index.html`;
      }

      getChapters(bibleVersionID, bibleBookID).then((chapterList) => {
        chapterHTML += `<ol>`;
        for (let chapter of chapterList) {
          chapterHTML += `<li class="grid"><a class="grid-link" href="verse.html?version=${bibleVersionID}&abbr=${abbreviation}&chapter=${chapter.id}"> ${chapter.number} </a></li>`;
        }
        chapterHTML += `</ol>`;
        bibleChapterList.innerHTML = chapterHTML;
      });

      document.querySelector(`#viewing`).innerHTML = `${bibleBookID}`;
      const breadcrumbsHTML = `
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="book.html?version=${bibleVersionID}&abbr=${abbreviation}">${abbreviation}</a></li>
    <li>${bibleBookID}</li>
  </ul>
`;
      breadcrumbs.innerHTML = breadcrumbsHTML;

      function getChapters(bibleVersionID, bibleBookID) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.withCredentials = false;

          xhr.addEventListener(`readystatechange`, function() {
            if (this.readyState === this.DONE) {
              const {
                data
              } = JSON.parse(this.responseText);
              const chapters = data.map(({
                number,
                id
              }) => {
                return {
                  number,
                  id
                };
              });

              resolve(chapters);
            }
          });

          xhr.open(
            `GET`,
            `https://api.scripture.api.bible/v1/bibles/${bibleVersionID}/books/${bibleBookID}/chapters`
          );
          xhr.setRequestHeader(`api-key`, "506a6f4d6b442351d08f7e1aeec6ac86");

          xhr.onerror = () => reject(xhr.statusText);

          xhr.send();
        });
      }

    </script>
  </body>

</html>
