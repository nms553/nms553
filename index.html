
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>SF HOMEPAGE CURRENT</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <script
    type="text/javascript"
    src="/js/lib/dummy.js"
    
  ></script>

    <link rel="stylesheet" type="text/css" href="/css/result-light.css">


  <style id="compiled-css" type="text/css">
          a {
        margin: 20px;
      }

      table {
        table-layout: fixed;
        border-collapse: collapse;
        width: 100%;
      }

      tr:nth-child(even) {
        background: #DFC;
      }

      td {
        font-size: 0.9em;
        padding: 0px 0px 0px 0px;
      }

      table:first-child td:first-child {
        width: 33%;
        font-size: 0.9em;
      }

      table:first-child td:nth-child(2) {
        width: 45%;
      }

      sup {
        font-size: 0.7em;
      }

      td:nth-child(3) {
        white-space: nowrap;
        font-size: 0.8em;
      }

      small {
        font-size: 0.65em;
        margin: 0px 0px 0px 3px;
      }

      p {
        margin: 5px;
        padding: 0px;
        font-size: 0.9em;
      }

      #livetable td {
        padding: 0px 3px 0px 3px;
        text-align: center;
      }

      #livetable td:first-child {
        width: 25px;
      }

      #livetable td:nth-child(2) {
        width: 140px;
        text-align: left;
      }

      #livetable td:nth-child(3) {
        width: 75px;
      }


    /* EOS */
  </style>

  <script id="insert"></script>

</head>
<body>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&display=swap" rel="stylesheet">
<link href="https://stupid-fast.com/css.css" rel="stylesheet">

<center>

  <a href="https://www.stupid-fast.com" class="banner">
    <img src="https://www.stupid-fast.com/banner/banner.png">
  </a>

  <div id="links"></div>

  <table id="pickstable">
    <tbody id="tbody"></tbody>
  </table>

  <br>
  <hr><br>

  <h1>Live scoring</h1>

  <br><br>

  <table id="livetable" border>
    <tbody id="tbodylive">
    </tbody>
  </table>

  <br><br>

  <script src="https://stupid-fast.com/gviz.js"></script>



  <br>
  <hr><br>

  <div id="flag" style="font-size: 3em;"></div>
  <main id="laps"></main>



</center>


    <script type="text/javascript">//<![CDATA[


var key = "1jwadkJYYfBmf-SbjUokDV0S_yzC7gD39-jHxVatJfLU"

gviz(key, "HOMEPAGE", "select *", function(result) {
  result.shift()
  result.shift()
  //console.log(result);
  result.forEach(function(item, index) {
    var el = document.createElement(item[1])
    el.href = item[2]
    el.innerText = item[0]
    el.className = item[6]
    el.target = item[4]
    el.style = item[5]
    links.appendChild(el)
  })
})

gviz(key, "PICKORDER", "select A, B, G order by G", function(result) {
  result.shift()
  //console.log(result);
  result.forEach(function(item) {
    var tr = tbody.insertRow()
    tr.id = item[0]
    var td = tr.insertCell()
    tr.insertCell()
    tr.insertCell()
    var sup = document.createElement("SUP")
    sup.innerHTML = item[1]
    td.append(sup)
  })
  getPlayerNames(result)
})

function getPlayerNames(pickorder) {
  gviz(key, "PLAYERS", "select A, B where C = true", function(result) {
    result.shift()
    //console.log(result);
    result.forEach(function(item) {
      var tr = document.getElementById(item[0])
      var td = tr.getElementsByTagName("TD")[0]
      var p = document.createElement("STRONG")
      p.style.display = "inline-block"
      p.innerHTML = item[1]
      td.prepend(p)
    })
    getDrivers()
  })
}

function getDrivers() {
  //console.log("running")
  gviz(key, "DRIVERS", "select A, B, D, E", function(result) {
    result.shift()
    //console.log(result);
    result.forEach(function(item) {
      try {
        var tr = document.getElementById(item[2])
        var p = document.createElement("P")
        p.innerHTML = item[1]
        var td = tr.getElementsByTagName("TD")[1]
        //console.log(item[3])
        if (item[3]) {
          tr.getElementsByTagName("TD")[2].innerHTML += item[3]
        }
        td.append(p)
      } catch (err) {}
    })
  })
}

//LIVE scoring RESULTS DATA
fetch("https://script.google.com/macros/s/AKfycbw5XAEcm4QL4-mD2A74apN2QP7bZPmwBUMtIRnbc75CGc3gffffQyoEP9gTY7H8Q6da/exec?key=raceset").then(function(data) {
  return data.text()
}).then(function(result) {
  getResults(result)
  getFlagData(result)
})

function getResults(id) {
	console.log(id)
  fetch("https://cf.nascar.com/live/feeds/series_1/" + id + "/live_feed.json").then(function(x) {
    //console.log("before then", x)
    return x.text()
  }).then(function(y) {
    tbodylive.innerHTML = ""
    //console.log("running order raw", y)
    var result = JSON.parse(y)
    console.log("getresults()", result)
    result.vehicles.forEach(function(item, index) {
      var margin = Math.round(item.delta * 10) / 10
      var tr = tbodylive.insertRow()
      tr.insertCell().innerText = index + 1
      tr.insertCell().innerHTML = item.driver.full_name + "<small>" + margin + "</small>"
      tr.insertCell().id = item.vehicle_number + "live"
    })
    getPicks()
  })
}


function getPicks() {
  var count = 1
  var players = []
  var bgcolors = [
    "red", "blue", "yellow", "green", "purple", "orange", "goldenrod", "lightgray", "black", "fuchsia", "olive"
  ]
  var colors = [
    "white", "white", "black", "white", "white", "white", "black", "black", "white", "white", "white"
  ]
  gviz("1jwadkJYYfBmf-SbjUokDV0S_yzC7gD39-jHxVatJfLU", "DRIVERS", "select A, C, D where D is not null", function(result) {
    result.shift()
    //console.log(result)
    result.forEach(function(item) {
      try {
        var td = document.getElementById(item[1] + "live")
        td.innerText = item[2]
        var indexof = players.indexOf(item[2])
        if (indexof < 0) {
          players.push(item[2])
          td.style.backgroundColor = bgcolors[players.length - 1]
          td.style.color = colors[players.length - 1]
        } else {
          td.style.backgroundColor = bgcolors[indexof]
          td.style.color = colors[indexof]
        }
      } catch (err) {}
    })
    //console.log(players)
    assignPts()
  })
}

function assignPts() {
  var score = 22
  var tr = tbodylive.getElementsByTagName("TR")
  for (var i of tr) {
    var td = i.insertCell()
    if (i.getElementsByTagName("TD")[2].innerText) {
      td.innerText = score--
    }
  }
}



//FLAG DATA
function getFlagData(raceid) {
  fetch("https://cf.nascar.com/cacher/2023/1/" + raceid + "/lap-notes.json").then(function(x) {
    return x.text();
  }).then(function(y) {
    var arr = JSON.parse(y)
    //console.log(arr)
    var keys = Object.keys(arr.laps)
    keys.forEach(function(item) {
      var p = document.createElement("P")
      p.innerHTML = "<b>Lap " + item + ": </b><br>" + arr.laps[item][0].Note + "<br><br>"
      laps.prepend(p)
    })
  })

  fetch("https://cf.nascar.com/live/feeds/live-flag-data.json").then(x => x.text()).then(function(result) {
    var parse = JSON.parse(result)
    //console.log(parse)
    var pop = parse.pop()
    //console.log(pop)

    switch (pop.flag_state) {
      case 8:
        flag.innerText = "🏴"
        break;

      case 1:
        flag.innerText = "🟢"
        break;

      case 2:
        flag.innerText = "🟡"
        break;

      case 4:
        flag.innerText = "🏁"
    }
  })
}



  //]]></script>

  <script>
    // tell the embed parent frame the height of the content
    if (window.parent && window.parent.parent){
      window.parent.parent.postMessage(["resultsFrame", {
        height: document.body.getBoundingClientRect().height,
        slug: "mebwpqh1"
      }], "*")
    }

    // always overwrite window.name, in case users try to set it manually
    window.name = "result"
  </script>


</body>
</html>
