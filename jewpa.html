<html>

  <head>
    <!-- meta name="viewport" content="width=device-width, initial-scale=1.0" /> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <style>
      html, body {font-family: sans-serif;}
      table,
      td,
      th {
        border: 1px solid;
        border-collapse: collapse;
      }

      table {
        margin-top: 30px;
      }

      td,
      th {
        width: 300px;
      }

      th {
        text-align: left;
      }
      
      td:nth-child(even) {
       background-color: lightgray; 
      }

    </style>
  </head>

  <body>
    
    <h2>Jewpa.com</h2>

    <form id="form" name="myForm" action="https://script.google.com/macros/s/AKfycbxbi6z8vMIHtWUYGeaRUm46-85MdpLSLpiRV_CRXzYOwfhWOObB/exec" method="get" target="dummyframe">
      <input type="hidden" name="idx" value="0">
      <input type="hidden" name="ordr" value="">
      <input type="text" name="item" placeholder="Item" />
      <input type="hidden" name="archive" value="">
      <br>
      <br>
      <input list="stores" name="category" type="text" placeholder="Store" />
    </form>

    <a href="" id="navigate"><button onclick="saveNew()">
        Save It
      </button></a>


    <datalist id="stores"></datalist>

    <br>

    <table id="none">
      <tr>
        <th>None</th>
      </tr>
    </table>





    <div id="body">

    </div>
    <script>
      var genesisarray = [];
      var originalarray = [];
      var archivedarray = [];
      var body = document.getElementById("body")
      var none = document.getElementById("none")
      var sheetUrl = 'https://spreadsheets.google.com/feeds/list/1gPV1KpSUCEE-0OebVmyy2Fpn-xRd8CvS0gC3E8BwzHc/1/public/full?alt=json';
      var datalist = document.getElementById("stores")
      var archive = document.getElementsByName("archive")[0]
      var order = document.getElementsByName("ordr")[0]
      var findex = document.getElementsByName("idx")[0]
      var category = document.getElementsByName("category")[0]
      var fitem = document.getElementsByName("item")[0]
      var form = document.getElementById("form")
      var navigate = document.getElementById("navigate")

      $(function() {
        $.getJSON(sheetUrl, feed)
      });

      function feed(data) {
        genesisarray = data.feed.entry;
        //console.log(genesisarray)
        next();
      }

      function next() {
        genesisarray.map(mapIndex);
        removeArchs();
      }

      function mapIndex(item, index) {
        item.index = index
      }

      function removeArchs() {
        body.innerHTML = ""
        none.innerHTML = ""
        filteredarray = genesisarray.filter(removeArchived);
        console.log(filteredarray)
        buildTables();
      }

      function buildTables() {


        //console.log(originalarray)
        let unique = [...new Set(filteredarray.map(item => item.gsx$category.$t))];
        //console.log(unique);
        unique.forEach(function(item, index) {
          if (item) {
            var option = document.createElement("OPTION")
            option.value = item
            datalist.appendChild(option);
            var table = document.createElement("TABLE")
            table.id = item
            //console.log(table.id)
            var newrow = table.insertRow()
            var th = document.createElement("TH")
            th.innerHTML = item
            newrow.appendChild(th)
            body.appendChild(table);
          } else {
            //console.log("no")
          }
        })
        sort();
      }

      function sort() {
        filteredarray.sort(function(a, b) {
          return b.gsx$order.$t - a.gsx$order.$t
        })
        //console.log(filteredarray);
        filteredarray.forEach(function(item, index) {
          var gettable = document.getElementById(item.gsx$category.$t);
          var a = document.createElement("A");
          a.href = "javascript:";
          a.setAttribute("onclick", "pin(this)");
          a.innerHTML = item.gsx$item.$t
          a.id = item.index
          a.setAttribute("data-newpos", index)
          a.className = item.gsx$category.$t
          if (!item.gsx$category.$t) {
            a.className = "none"
            gettable = document.getElementById("none");
          }
          if (!item.gsx$archive.$t) {}
          var newrow = gettable.insertRow()
          var newcell = newrow.insertCell(0)
          newcell.appendChild(a);
        })
      }

      function pin(that) {
        //console.log(that);
        //console.log("^^is the one you clicked")
        var newpos = that.getAttribute("data-newpos")
        var origpos = that.id;
        var zeroindex = document.getElementsByClassName(that.className)[0];
        //console.log(zeroindex);
        //console.log("^^is the top of the list")

        if (that.innerHTML === zeroindex.innerHTML) {
          //console.log(genesisarray[origpos])
          genesisarray[origpos].gsx$archive.$t = "1"
          archive.value = "1"
        } else {
          genesisarray[that.id].gsx$order.$t = Date.now()
        }
        order.value = Date.now()
        findex.value = origpos
        //console.log(archive.value)
        $("form").submit();
        archive.value = ""
        order.value = ""
        findex.value = "0"

        next();
      }

      function removeArchived(item) {
        return !item.gsx$archive.$t
      }

      function saveNew() {
        var len = genesisarray.length

        var savenew = genesisarray.push({
          gsx$item: {
            $t: fitem.value
          },
          gsx$order: {
            $t: Date.now()
          },
          gsx$category: {
            $t: category.value
          },
          gsx$archive: {
            $t: ""
          },
          title: {
            $t: ""
          }
        })
        order.value = Date.now()
        form.submit();
        navigate.href = "#" + category.value
        fitem.value = ""
        category.value = ""
        archive.value = ""
        order.value = ""
        next();

      }

    </script>

    <iframe width="0" height="0" border="0" name="dummyframe" id="dummyframe" style="display:none;"></iframe><br>
    <a target="_blank" href="https://script.google.com/d/1ZtCxDsRdIRMH_h-mohAlBgWuCEb7TF-mP6H9rhhs31KYLwe_D5f3fdCR/edit?usp=sharing">Script</a> -
    <a target="_blank" href="https://github.com/nms553/nms553.github.io/edit/master/jewpa.html">Github</a> -
    <a target="_blank" href="https://docs.google.com/spreadsheets/d/1gPV1KpSUCEE-0OebVmyy2Fpn-xRd8CvS0gC3E8BwzHc/edit">Sheets</a>
  </body>

</html>
