<html>

  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <style>
      table,
      td,
      th {
        border: 1px solid;
        border-collapse: collapse;
      }

      table {
        margin-top: 30px;
      }

      td,
      th {
        width: 300px;
      }

      th {
        text-align: left;
      }

    </style>
  </head>

  <body>

    <form id="form" name="myForm" action="https://script.google.com/macros/s/AKfycbxbi6z8vMIHtWUYGeaRUm46-85MdpLSLpiRV_CRXzYOwfhWOObB/exec" method="get" target="dummyframe">
      <input type="hidden" name="idx" value="0">
      <input type="hidden" name="ordr" value="">
      <input type="text" name="item" placeholder="Item" />
      <input type="hidden" name="archive" value="">
      <br>
      <br>
      <input list="stores" name="category" type="text" placeholder="Store" />
    </form>
    <br>
    <button onclick="saveNew()">
      Save It
    </button>


    <datalist id="stores">
      <option>Hardware store</option>
      <option>Grocery store</option>
      <option>Online</option>
      <option>Home Depot></option>
      <option>House projects</option>
      <option>Lowes</option>
      <option>Amazon</option>
      <option>Walmart</option>
      <option>Target</option>
    </datalist>

    <br><br>

    <table id="none">
      <tr>
        <th>None</th>
      </tr>
    </table>





    <div id="body">

    </div>
    <script>
      var genesisarray = [];
      var originalarray = [];
      var archivedarray = [];
      var body = document.getElementById("body")
      var none = document.getElementById("none")
      var sheetUrl = 'https://spreadsheets.google.com/feeds/list/1gPV1KpSUCEE-0OebVmyy2Fpn-xRd8CvS0gC3E8BwzHc/4/public/full?alt=json';
      var datalist = document.getElementById("stores")

      $(function() {
        $.getJSON(sheetUrl, feed)
      });

      function feed(data) {
        genesisarray = data.feed.entry;
        console.log(genesisarray)
        genesisarray.map(mapIndex);

        function mapIndex(item, index) {
          item.index = index
        }

        removeArchs();
      }

      function removeArchs() {
        filteredarray = genesisarray.filter(removeArchived);
        buildTables();
      }

      function buildTables() {

        body.innerHTML = ""
        none.innerHTML = ""
        //console.log(originalarray)
        let unique = [...new Set(filteredarray.map(item => item.gsx$category.$t))];
        console.log(unique);
        unique.forEach(function(item, index) {
          if (item) {
            var option = document.createElement("OPTION")
            option.value = item
            datalist.appendChild(option);
            var table = document.createElement("TABLE")
            table.id = item
            //console.log(table.id)
            var newrow = table.insertRow()
            var th = document.createElement("TH")
            th.innerHTML = item
            newrow.appendChild(th)
            body.appendChild(table);
          } else {
            //console.log("no")
          }
        })
        sort();
      }

      function sort() {
        filteredarray.sort(function(a, b) {
          return b.gsx$order.$t - a.gsx$order.$t
        })
        console.log(filteredarray);
        filteredarray.forEach(function(item, index) {
          var gettable = document.getElementById(item.gsx$category.$t);
          var a = document.createElement("A");
          a.href = "javascript:";
          a.setAttribute("onclick", "pin(this)");
          a.innerHTML = item.gsx$item.$t
          a.id = item.index
          a.setAttribute("data-newpos", index)
          a.className = item.gsx$category.$t
          if (!item.gsx$category.$t) {
            a.className = "none"
            gettable = document.getElementById("none");
          }
          if (!item.gsx$archive.$t) {}
          var newrow = gettable.insertRow()
          var newcell = newrow.insertCell(0)
          newcell.appendChild(a);
        })
      }

      function pin(that) {
        console.log(that)
        var newpos = that.getAttribute("data-newpos")
        var origpos = that.id;
        console.log(origpos)
        var zeroindex = document.getElementsByClassName(that.className)[0];
        console.log(genesisarray[origpos].gsx$item.$t)
        var indax = parseInt(origpos) + 2

        if (that.innerHTML == zeroindex.innerHTML) {
          genesisarray[origpos].gsx$archive.$t = "none"
          document.getElementsByName("archive")[0].value = "1"
        } else {
          genesisarray[that.id].gsx$order.$t = Date.now()
        }
        document.getElementsByName("ordr")[0].value = Date.now()
        document.getElementsByName("idx")[0].value = indax
        $("form").submit();
        removeArchs();
        //console.log(originalarray[that.id])
        //console.log(originalarray[that.id])

        console.log(zeroindex)
        /*if (var tablerank = document.getElementsByClassName(cname)[0].innerHTML;)
        
        var idx = this.index
        
        var order = document.getElementsByName("ordr")[0];
        document.getElementsByName("idx")[0].value = that

        console.log(that.className)
        var tablerank = document.getElementsByClassName(that.className)[0].innerHTML;
        if (tablerank == archivedarray[that.id].gsx$item.$t) {
          document.getElementsByName("archive")[0].value = "1";
          tablerank.gsx$archive.$t = "none"
          that.parentElement.parentElement.style.display = "none"
        }
        archivedarray[id].gsx$order.$t = Date.now();
        var location = archivedarray[id].title.$t;
        //console.log(archivedarray[id]);

        //console.log(archivedarray);
        var order = document.getElementsByName("ordr")[0];
        var index = document.getElementsByName("idx")[0];
        order.value = Date.now();
        index.value = location.split(": ")[1];
        //console.log(index.value)
        $("form").submit();
        startDOM();*/
      }

      function removeArchived(item) {
        return !item.gsx$archive.$t
      }

      function saveNew() {
        var len = genesisarray.length
        var item = document.getElementsByName("item")[0].value
        var category = document.getElementsByName("category")[0].value

        var savenew = genesisarray.push({
          gsx$item: {
            $t: item
          },
          gsx$order: {
            $t: Date.now()
          },
          gsx$category: {
            $t: category
          },
          gsx$archive: {
            $t: ""
          },
          title: {
            $t: ""
          }
        })

        len = genesisarray.length
        console.log(genesisarray[len])
        document.getElementsByName("ordr")[0].value = Date.now()
        document.getElementById("form").submit();
        document.getElementsByName("item")[0].value = ""
        document.getElementsByName("category")[0].value = ""
        removeArchs();

      }

    </script>

    <iframe width="0" height="0" border="0" name="dummyframe" id="dummyframe" style="display:none;"></iframe><br>
    <a target="_blank" href="https://script.google.com/d/1ZtCxDsRdIRMH_h-mohAlBgWuCEb7TF-mP6H9rhhs31KYLwe_D5f3fdCR/edit?usp=sharing">Script</a> -
    <a target="_blank" href="https://github.com/nms553/nms553.github.io/edit/master/jewpa.html">Github</a> -
    <a target="_blank" href="https://docs.google.com/spreadsheets/d/1gPV1KpSUCEE-0OebVmyy2Fpn-xRd8CvS0gC3E8BwzHc/edit">Sheets</a>
  </body>

</html>
