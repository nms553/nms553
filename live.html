


<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>

<body>

<select id="select" onchange="getRaceData(this.value)"></select>
<br><br>
<p id="loading">LOADING......(data will only be displayed during race)</p>
<br>
<table id="table" border="1">
  <thead>
    <tr>
      <th>Player</th>
      <th>Driver 1</th>
      <th>Driver 2</th>
      <th>Pos 1</th>
      <th>Pos 2</th>
      <th>Pts 1</th>
      <th>Pts 2</th>
      <th>Bonus</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody id="tbody">
	  
	 
  </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", getRaceID);
var runonce = 0;

function getRaceID() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var result = JSON.parse(this.responseText);
      console.log(result);

      var rid;
      result.series_1.forEach(function(item, i) {
        if (item.winner_driver_id) {
          rid = item.race_id + 1
          result.series_1.forEach(function(item, index) {
          	var opt = document.createElement("OPTION")
            opt.value = item.race_id
            opt.text = item.track_name
            select.add(opt)
          })
          select.value = rid
        }
      })



      getRaceData(rid)
    }

  };

  xhttp.open(
    "GET",
    "https://cf.nascar.com/cacher/2022/race_list_basic.json",
    true
  );
  xhttp.send();

}



function getRaceData(rid) {
	loading.style.display = ""
    table.style.display = "none"

  //console.log(rid)
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var result = JSON.parse(this.responseText);
      console.log("getRaceData")
      console.log(result);
      getAlias(rid, result.vehicles)
    }

  };

  xhttp.open(
    "GET",
    "https://cf.nascar.com/live/feeds/series_1/" + rid + "/live_feed.json",
    true
  );
  xhttp.send();
}





function getAlias(rid, nascar) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var result = JSON.parse(this.responseText);
      //CODE BELOW HERE***************
      //console.log(result);
      //console.log(nascar);

      var counter = result.Player.filter(function(item) {
        return item.active == true;
      }).length * 2

      nascar.forEach(function(item, i) {
        result.Alias.forEach(function(jtem, j) {
          var trim = item.driver.full_name.replace(" #", "").replace("* ", "").split(" (")[0].split("(")[0]
          if (trim == jtem.alias) {
            result.Player.forEach(function(ktem, k) {
              if (!ktem.bonus) {
                ktem.bonus = 0
              }
              if (ktem.driverid1 == jtem.driverid) {
                if (parseInt(item.running_position) < 2) {
                  ktem.bonus = ktem.bonus + 2
                  console.log(item.running_position)
                }
                ktem.pos1 = item.running_position
                ktem.pts1 = counter
                counter--
              }

              if (ktem.driverid2 == jtem.driverid) {
                if (parseInt(item.running_position) < 2) {
                  ktem.bonus = ktem.bonus + 2
                  console.log(item.running_position)
                }
                ktem.pos2 = item.running_position
                ktem.pts2 = counter
                counter--
              }

            })

          }
        })

      })
      //console.log(result)
      getStage(rid, result)
      //CODE ABOVE HERE***************
    }

  };

  xhttp.open(
    "GET",
    "https://script.google.com/macros/s/AKfycbxWY4yfPYawPQlV60bP6pMoZbvW124OZSMf_ftGk3QkUUyuFoDvnClgScK3JXHyu--w/exec",
    true
  );
  xhttp.send();
}





function getStage(rid, stupidfast) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
  
  
    if (this.readyState == 4 && this.status == 200) {
    	
      var result = JSON.parse(this.responseText);
      //CODE BELOW HERE***************
      //console.log(result);
      result.forEach(function(item, index) {
        var drivername = item.results[0].full_name.replace(" #", "").replace("* ", "").split(" (")[0].split("(")[0]
        //console.log(drivername)
        stupidfast.Alias.forEach(function(jtem, j) {
          if (drivername == jtem.alias) {
            stupidfast.Player.forEach(function(ktem, k) {

              if (ktem.driverid1 == jtem.driverid) {
                ktem.bonus++
              }

              if (ktem.driverid2 == jtem.driverid) {
                ktem.bonus++
              }
            })
          }
        })
      })
      //CODE ABOVE HERE***************
      summaryTable(stupidfast.Player)
    } else {
    console.log("ready")
    if (runonce < 1) {
    summaryTable(stupidfast.Player)
    runonce++
    }
    
    }

  };

  xhttp.open(
    "GET",
    "https://cf.nascar.com/cacher/2022/1/" + rid + "/live-stage-points.json",
    true
  );
  xhttp.send();
}






function summaryTable(result) {
  //console.log(result)
loading.style.display = "none"
table.style.display = ""
  result.forEach(function(item, index) {

    if (item.active) {
      var tr = tbody.insertRow()
      tr.insertCell().innerText = item.player
      tr.insertCell().innerText = item.driver1
      tr.insertCell().innerText = item.driver2
      tr.insertCell().innerText = item.pos1
      tr.insertCell().innerText = item.pos2
      tr.insertCell().innerText = item.pts1
      tr.insertCell().innerText = item.pts2
      tr.insertCell().innerText = item.bonus
      tr.insertCell().innerText = 0
    }

  })

  var tr = document.getElementsByTagName("TR")
  var i;
  for (i = 1; i < tr.length; i++) {
    var td5 = parseInt(tr[i].getElementsByTagName("td")[5].innerText)
    var td6 = parseInt(tr[i].getElementsByTagName("td")[6].innerText)
    var td7 = parseInt(tr[i].getElementsByTagName("td")[7].innerText)
    tr[i].getElementsByTagName("td")[8].innerText = td5 + td6 + td7
  }

}


</script>
</body>
</html>
